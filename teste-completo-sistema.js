// üî•üî•üî• TESTE COMPLETO E DETALHADO - TODAS AS FUNCIONALIDADES üî•üî•üî•
console.log('üöÄüöÄüöÄ INICIANDO TESTE COMPLETO DO SISTEMA üöÄüöÄüöÄ');

const API_BASE = 'http://localhost:3001';
let adminToken = null;
let testCustomerId = null;
let testOrderId = null;

// üìù RELAT√ìRIO DE TESTES
const relatorio = {
    backend: { status: '‚ùå', detalhes: '' },
    database: { status: '‚ùå', detalhes: '' },
    produtos: { status: '‚ùå', detalhes: '' },
    categorias: { status: '‚ùå', detalhes: '' },
    adminLogin: { status: '‚ùå', detalhes: '' },
    criarPedido: { status: '‚ùå', detalhes: '' },
    dashboard: { status: '‚ùå', detalhes: '' },
    errors: []
};

function log(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const symbols = {
        info: '‚ÑπÔ∏è',
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        test: 'üß™'
    };
    console.log(`${symbols[type]} [${timestamp}] ${message}`);
}

function addError(funcionalidade, erro) {
    relatorio.errors.push({ funcionalidade, erro, timestamp: new Date().toLocaleTimeString() });
}

// üß™ TESTE 1: BACKEND HEALTH
async function testeBackendHealth() {
    log('Testando conectividade do backend...', 'test');
    try {
        const response = await fetch(`${API_BASE}/health`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        log(`Backend OK - Status: ${data.status}, Uptime: ${data.uptime}s`, 'success');
        relatorio.backend = { status: '‚úÖ', detalhes: `Uptime: ${data.uptime}s` };
        return true;
    } catch (error) {
        const msg = `Backend falhou: ${error.message}`;
        log(msg, 'error');
        relatorio.backend = { status: '‚ùå', detalhes: msg };
        addError('Backend Health', error.message);
        return false;
    }
}

// üß™ TESTE 2: SUPABASE DATABASE
async function testeDatabase() {
    log('Testando conex√£o com Supabase...', 'test');
    try {
        const response = await fetch(`${API_BASE}/api/test-supabase`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        if (data.success) {
            log('Supabase conectado com sucesso!', 'success');
            relatorio.database = { status: '‚úÖ', detalhes: 'Conex√£o OK' };
            return true;
        } else {
            throw new Error(data.error?.message || 'Erro desconhecido');
        }
    } catch (error) {
        const msg = `Database falhou: ${error.message}`;
        log(msg, 'error');
        relatorio.database = { status: '‚ùå', detalhes: msg };
        addError('Database', error.message);
        return false;
    }
}

// üß™ TESTE 3: CARREGAR PRODUTOS
async function testeProdutos() {
    log('Testando carregamento de produtos...', 'test');
    try {
        const response = await fetch(`${API_BASE}/api/products`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        if (data.success && data.data) {
            const produtos = data.data;
            log(`${produtos.length} produtos carregados com sucesso!`, 'success');
            
            // Verificar estrutura dos produtos
            const primeiroProduto = produtos[0];
            const camposObrigatorios = ['id', 'name', 'price', 'description'];
            const camposFaltando = camposObrigatorios.filter(campo => !primeiroProduto[campo]);
            
            if (camposFaltando.length > 0) {
                throw new Error(`Campos faltando nos produtos: ${camposFaltando.join(', ')}`);
            }
            
            relatorio.produtos = { status: '‚úÖ', detalhes: `${produtos.length} produtos` };
            return produtos;
        } else {
            throw new Error(data.error?.message || 'Erro desconhecido');
        }
    } catch (error) {
        const msg = `Produtos falhou: ${error.message}`;
        log(msg, 'error');
        relatorio.produtos = { status: '‚ùå', detalhes: msg };
        addError('Produtos', error.message);
        return [];
    }
}

// üß™ TESTE 4: CARREGAR CATEGORIAS
async function testeCategorias() {
    log('Testando carregamento de categorias...', 'test');
    try {
        const response = await fetch(`${API_BASE}/api/categories`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        if (data.success && data.data) {
            const categorias = data.data;
            log(`${categorias.length} categorias carregadas!`, 'success');
            relatorio.categorias = { status: '‚úÖ', detalhes: `${categorias.length} categorias` };
            return categorias;
        } else {
            throw new Error(data.error?.message || 'Erro desconhecido');
        }
    } catch (error) {
        const msg = `Categorias falhou: ${error.message}`;
        log(msg, 'error');
        relatorio.categorias = { status: '‚ùå', detalhes: msg };
        addError('Categorias', error.message);
        return [];
    }
}

// üß™ TESTE 5: LOGIN ADMIN
async function testeAdminLogin() {
    log('Testando login de administrador...', 'test');
    try {
        const response = await fetch(`${API_BASE}/api/auth/login`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: 'admin@cachorromelo.com',
                password: 'admin123'
            })
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        if (data.success && data.admin) {
            adminToken = data.token;
            log(`Login admin OK! Usu√°rio: ${data.admin.name}`, 'success');
            relatorio.adminLogin = { status: '‚úÖ', detalhes: `Admin: ${data.admin.name}` };
            return data.admin;
        } else {
            throw new Error(data.error?.message || 'Credenciais inv√°lidas');
        }
    } catch (error) {
        const msg = `Admin login falhou: ${error.message}`;
        log(msg, 'error');
        relatorio.adminLogin = { status: '‚ùå', detalhes: msg };
        addError('Admin Login', error.message);
        return null;
    }
}

// üß™ TESTE 6: CRIAR PEDIDO COMPLETO
async function testeCriarPedido(produtos) {
    log('Testando cria√ß√£o de pedido completo...', 'test');
    
    if (!produtos || produtos.length === 0) {
        const msg = 'N√£o √© poss√≠vel criar pedido sem produtos';
        log(msg, 'error');
        relatorio.criarPedido = { status: '‚ùå', detalhes: msg };
        return null;
    }
    
    try {
        // Selecionar primeiro produto dispon√≠vel
        const produtoTeste = produtos.find(p => p.available) || produtos[0];
        
        const pedidoTeste = {
            customer: {
                name: 'Jo√£o da Silva Teste',
                phone: '11987654321',
                email: 'teste@cachorromelo.com'
            },
            items: [
                {
                    productId: produtoTeste.id,
                    name: produtoTeste.name,
                    quantity: 2,
                    price: produtoTeste.price
                }
            ],
            total: produtoTeste.price * 2,
            deliveryAddress: 'Rua das Flores, 123 - S√£o Paulo, SP',
            paymentMethod: 'money',
            notes: 'Teste automatizado do sistema'
        };
        
        log(`Criando pedido teste: ${pedidoTeste.items[0].name} x${pedidoTeste.items[0].quantity}`, 'info');
        
        const response = await fetch(`${API_BASE}/api/orders`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(pedidoTeste)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        if (data.success && data.data) {
            testOrderId = data.data.id;
            log(`Pedido criado com sucesso! N√∫mero: ${data.data.orderNumber}`, 'success');
            relatorio.criarPedido = { status: '‚úÖ', detalhes: `Pedido #${data.data.orderNumber}` };
            return data.data;
        } else {
            throw new Error(data.error?.message || 'Erro ao criar pedido');
        }
    } catch (error) {
        const msg = `Criar pedido falhou: ${error.message}`;
        log(msg, 'error');
        relatorio.criarPedido = { status: '‚ùå', detalhes: msg };
        addError('Criar Pedido', error.message);
        return null;
    }
}

// üß™ TESTE 7: DASHBOARD ADMIN
async function testeDashboard() {
    log('Testando dashboard do admin...', 'test');
    try {
        const response = await fetch(`${API_BASE}/api/admin/dashboard`, {
            headers: adminToken ? { 'Authorization': `Bearer ${adminToken}` } : {}
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        if (data.success && data.data) {
            const stats = data.data;
            log(`Dashboard OK - Produtos: ${stats.totalProducts}, Pedidos: ${stats.totalOrders}`, 'success');
            relatorio.dashboard = { status: '‚úÖ', detalhes: `${stats.totalProducts} produtos, ${stats.totalOrders} pedidos` };
            return stats;
        } else {
            throw new Error(data.error?.message || 'Erro no dashboard');
        }
    } catch (error) {
        const msg = `Dashboard falhou: ${error.message}`;
        log(msg, 'error');
        relatorio.dashboard = { status: '‚ùå', detalhes: msg };
        addError('Dashboard', error.message);
        return null;
    }
}

// üß™ TESTE 8: BUSCAR PEDIDOS
async function testeBuscarPedidos() {
    log('Testando busca de pedidos...', 'test');
    try {
        const response = await fetch(`${API_BASE}/api/orders`);
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        if (data.success) {
            const pedidos = data.data || [];
            log(`${pedidos.length} pedidos encontrados`, 'success');
            return pedidos;
        } else {
            throw new Error(data.error?.message || 'Erro ao buscar pedidos');
        }
    } catch (error) {
        log(`Buscar pedidos falhou: ${error.message}`, 'error');
        addError('Buscar Pedidos', error.message);
        return [];
    }
}

// üìä RELAT√ìRIO FINAL
function gerarRelatorioFinal() {
    console.log('\nüî•üî•üî• RELAT√ìRIO FINAL DOS TESTES üî•üî•üî•');
    console.log('===============================================');
    
    console.log('\nüìã RESULTADOS POR FUNCIONALIDADE:');
    Object.entries(relatorio).forEach(([funcionalidade, resultado]) => {
        if (funcionalidade !== 'errors') {
            console.log(`${resultado.status} ${funcionalidade.toUpperCase()}: ${resultado.detalhes}`);
        }
    });
    
    const totalTestes = Object.keys(relatorio).length - 1; // -1 para excluir 'errors'
    const testesPassaram = Object.values(relatorio).filter(r => r.status === '‚úÖ').length;
    const tesvesFalharam = totalTestes - testesPassaram;
    
    console.log('\nüìä ESTAT√çSTICAS:');
    console.log(`‚úÖ Testes que passaram: ${testesPassaram}/${totalTestes}`);
    console.log(`‚ùå Testes que falharam: ${tesvesFalharam}/${totalTestes}`);
    console.log(`üìà Taxa de sucesso: ${Math.round((testesPassaram/totalTestes)*100)}%`);
    
    if (relatorio.errors.length > 0) {
        console.log('\nüö® ERROS ENCONTRADOS:');
        relatorio.errors.forEach((erro, index) => {
            console.log(`${index + 1}. [${erro.timestamp}] ${erro.funcionalidade}: ${erro.erro}`);
        });
    }
    
    if (testesPassaram === totalTestes) {
        console.log('\nüéâüéâüéâ TODOS OS TESTES PASSARAM! SISTEMA 100% FUNCIONAL! üéâüéâüéâ');
    } else {
        console.log('\n‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ALGUNS TESTES FALHARAM - NECESS√ÅRIO CORRE√á√ÉO ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è');
    }
    
    console.log('===============================================');
}

// üöÄ EXECUTAR TODOS OS TESTES
async function executarTodosOsTestes() {
    log('Iniciando bateria completa de testes...', 'info');
    
    // Testes b√°sicos
    const backendOk = await testeBackendHealth();
    if (!backendOk) {
        log('‚ùå Backend n√£o est√° funcionando - abortando testes', 'error');
        gerarRelatorioFinal();
        return;
    }
    
    await testeDatabase();
    const produtos = await testeProdutos();
    await testeCategorias();
    await testeAdminLogin();
    
    // Testes avan√ßados
    await testeCriarPedido(produtos);
    await testeDashboard();
    await testeBuscarPedidos();
    
    // Relat√≥rio final
    gerarRelatorioFinal();
}

// Executar testes
executarTodosOsTestes().catch(error => {
    console.error('üí• ERRO CR√çTICO NOS TESTES:', error);
});